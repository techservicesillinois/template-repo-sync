#!/usr/bin/env python
# DO NOT EDIT - Update techservicesillinois/splunk-soar-template first

"""
description:
  Compare and update repo to match template.

example:
    template compare
    template update
"""

import argparse
import filecmp
import os
import shutil
import sys
import tempfile
import tomllib

from os import makedirs
from os.path import basename, dirname, join, splitext
from urllib.parse import urljoin

import requests

TMPDIR = tempfile.TemporaryDirectory(prefix='template-repo-sync')

TMP_FILES = {}


def remote_download(url, path):
    '''Download files from remote url to tmpdir. '''
    response = requests.get(urljoin(url, path))

    if response.status_code == 200:
        filename = join(TMPDIR.name, path)
        directory = dirname(filename)

        makedirs(directory, exist_ok=True)
        with open(filename, 'wb') as f:
            f.write(response.content)
    else:
        raise Exception(
            f"Failed to download {path}. "
            f"Status code: {response.status_code}"
        )

    return filename


def compare_repo(args):
    '''Compare unchanging files to template files'''
    differ = False

    for filename, tmpf in TMP_FILES.items():
        if not os.path.isfile(filename):
            print(f"{filename} is missing.", file=sys.stderr)
            differ = True
        else:
            if not filecmp.cmp(filename, tmpf, shallow=False):
                differ = True
                print(f"{filename} differs.", file=sys.stderr)

    if differ:
        sys.exit(1)
    else:
        sys.exit(0)


def update_repo(args):
    '''Update unchanging files to latest version from template'''
    for filename, tmpf in TMP_FILES.items():
        try:
            shutil.copyfile(tmpf, filename)
        except Exception as ex:
            print(f"Failed to update {filename}. {ex.message}",
                  file=sys.stderr)
            sys.exit(1)

    sys.exit(0)


def generate(args, files):
    msg = "# Ignore files managed by borg in Github PR reviews\n"
    with open(args.FILE, "w") as file:
        if args.FILE == '.gitattributes':
            file.write(msg)
            if len(files) > 0:
                file.write(' linguist-generated\n'.join(files))
                file.write(' linguist-generated\n')
                file.write('requirements*.txt linguist-generated\n')


def directory(path):
    if not os.path.isdir(path):
        raise argparse.ArgumentTypeError(f"{path}: not a valid directory.")
    return path


class MakeDependencyFile(argparse.FileType):
    def __call__(self, path):
        return super().__call__(path + ".d")


def init_parser():
    parser = argparse.ArgumentParser(
        description=__doc__,
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    parser.add_argument(
        "-s",
        "--source-dir",
        type=directory,
        help="Local directory instead of remote git repository")
    parser.add_argument(
        "-c",
        "--config",
        default=".borg.toml",
        metavar="FILE",
        type=argparse.FileType('rb'),
        help="Open TOML config file")
    parser.add_argument(
            "-m",
            "--make-target",
            metavar="TARGET",
            type=MakeDependencyFile('w'),
            help="Writes a Makefile dependency TARGET.d file: "
                 "TARGET.d will configure the TARGET to depend on "
                 "the files checked by borg compare.")
    subparsers = parser.add_subparsers()

    update = subparsers.add_parser('update', aliases=['up'])
    update.set_defaults(func=update_repo)

    compare = subparsers.add_parser('compare', aliases=['cmp'])
    compare.set_defaults(func=compare_repo)

    gen = subparsers.add_parser('generate', aliases=['gen'])
    gen.add_argument('FILE', choices=('.gitattributes', ),
                     help='Build certain template files')
    gen.set_defaults(func=generate)

    return parser



def main():
    parser = init_parser()
    args = parser.parse_args()

    if '.git' not in os.listdir(os.curdir):
        print("borg must run from repository root.")
        exit(1)

    config = tomllib.load(args.config)
    remote_config = None

    if args.make_target:
        target = splitext(basename(args.make_target.name))[0]
        print(f"{target}: {' '.join(FILES)}", file=args.make_target)

    url = config.get('source').get('url')

    if not config.get('template') or not config.get('template').get('files'):
        remote_config_file = remote_download(url, '.borg.template.toml')
        remote_config = tomllib.load(open(remote_config_file, 'rb'))


    if args.source_dir:
        for path in config.get('template')['files']:
            file_path = os.path.join(args.source_dir, path)
            if not os.path.isfile(file_path):
                print(f"Missing file in `--source-dir`: {file_path}",
                      file=sys.stderr)
                exit(1)
            TMP_FILES[path] = file_path
    else:
        for path in remote_config.get('template')['files']:
            file_path = remote_download(url, path)

            if not os.path.isfile(file_path):
                print(f"Missing file at `{url}`: {path}",
                      file=sys.stderr)
                exit(1)
            TMP_FILES[path] = file_path

    if hasattr(args, 'func'):
        args.func(args)
    else:
        parser.print_help(sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
